"use strict";exports.id=750,exports.ids=[750],exports.modules={6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,s){return s in t?t[s]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,s)):"function"==typeof t&&"default"===s?t:void 0}}})},5331:(e,t,s)=>{s.d(t,{S:()=>i});class r extends Error{constructor(e){super(`Environment validation failed: ${e}`),this.name="ValidationError"}}let a=null;function i(){return a||(a=function(){let e,t;let s=[],a=process.version;for(let[e,t]of(a.startsWith("v20.")||s.push(`Node.js version must be 20.x, got ${a}`),Object.entries({N8N_INGEST_URL:"Webhook endpoint URL",WEBHOOK_SECRET:"Webhook HMAC secret",FRED_API_KEY:"FRED API key for macro data",NEXT_PUBLIC_SUPABASE_URL:"Supabase project URL",NEXT_PUBLIC_SUPABASE_ANON_KEY:"Supabase anonymous key"})))process.env[e]||s.push(`${e} is required (${t})`);let i=(e,t)=>{let r=process.env[e];if(!r)return t;let a=parseInt(r,10);return isNaN(a)?(s.push(`${e} must be a number, got "${r}"`),t):a},n=process.env.N8N_INGEST_URL||"";n&&!n.startsWith("https://")&&s.push("N8N_INGEST_URL must be HTTPS");let o=process.env.WEBHOOK_SECRET||"";if(o&&o.length<16&&s.push("WEBHOOK_SECRET must be at least 16 characters"),s.length>0)throw console.error("‚ùå Environment validation failed:"),s.forEach(e=>console.error(`   - ${e}`)),new r(s.join("; "));let c={node_version:a,n8n_ingest_url:n,webhook_secret:o,tenant_id:(e="CAPSIGHT_TENANT_ID",t="demo",process.env[e]||t),fred_api_key:process.env.FRED_API_KEY,supabase_url:"https://azwkiifefkwewruyplcj.supabase.co",supabase_anon_key:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6d2tpaWZlZmt3ZXdydXlwbGNqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4Mzg2ODgsImV4cCI6MjA3MTQxNDY4OH0.kURMn0Ya-eQhYblA5dN3mFSIia-VoipcMrGhjIVEBz8",supabase_service_role_key:process.env.SUPABASE_SERVICE_ROLE_KEY,cache_ttl_macro_minutes:i("CACHE_TTL_MACRO_MINUTES",30),freshness_macro_days:i("FRESHNESS_MACRO_DAYS",7),freshness_fundamentals_days:i("FRESHNESS_FUNDAMENTALS_DAYS",90),freshness_comps_days:i("FRESHNESS_COMPS_DAYS",180),circuit_breaker_failure_threshold:i("CIRCUIT_BREAKER_FAILURE_THRESHOLD",3),circuit_breaker_timeout_minutes:i("CIRCUIT_BREAKER_TIMEOUT_MINUTES",2)};return console.log("‚úÖ Environment validation passed"),console.log(`   Node.js: ${c.node_version}`),console.log(`   Tenant: ${c.tenant_id}`),console.log(`   Webhook: ${c.n8n_ingest_url.substring(0,50)}...`),c}()),a}},8916:(e,t,s)=>{s.d(t,{z:()=>u});var r=s(4770),a=s(5331);class i{constructor(e,t=2){this.threshold=e,this.failures=0,this.lastFailureTime=null,this.state="CLOSED",this.timeout=6e4*t}canExecute(){return"CLOSED"===this.state||"OPEN"!==this.state||!!(this.lastFailureTime&&Date.now()-this.lastFailureTime>this.timeout)&&(this.state="HALF_OPEN",!0)}onSuccess(){this.failures=0,this.state="CLOSED",this.lastFailureTime=null}onFailure(){this.failures++,this.lastFailureTime=Date.now(),this.failures>=this.threshold&&(this.state="OPEN")}getState(){return{state:this.state,failures:this.failures,lastFailureTime:this.lastFailureTime?new Date(this.lastFailureTime).toISOString():null}}}class n{static{this.latencies=[]}static{this.retryCount=0}static{this.successCount=0}static{this.failureCount=0}static recordLatency(e){this.latencies.push(e),this.latencies.length>1e3&&this.latencies.shift()}static recordRetry(){this.retryCount++}static recordSuccess(){this.successCount++}static recordFailure(){this.failureCount++}static getMetrics(){let e=[...this.latencies].sort((e,t)=>e-t),t=e[Math.floor(.5*e.length)]||0,s=e[Math.floor(.95*e.length)]||0,r=this.successCount+this.failureCount,a=r>0?this.successCount/r:0;return{webhook_post_latency_ms_p50:t,webhook_post_latency_ms_p95:s,webhook_retries_total:this.retryCount,webhook_success_ratio:a,total_requests:r}}}class o{static{this.auditLog=[]}constructor(){this.config=(0,a.S)(),this.circuitBreaker=new i(this.config.circuit_breaker_failure_threshold,this.config.circuit_breaker_timeout_minutes)}async send(e,t){let s=t||(0,r.randomUUID)(),a=Date.now();try{let t=this.validatePayload(e);if(!t.valid)return console.error(`‚ùå Webhook validation failed [${s}]:`,t.errors),{success:!1,requestId:s,attempts:0,error:`Validation failed: ${t.errors.join(", ")}`};let r=this.adjustForStaleness(e),i=this.addPayloadHash(r);if(!this.circuitBreaker.canExecute())return console.warn(`‚ö° Circuit breaker OPEN [${s}]`),{success:!1,requestId:s,attempts:0,error:"Circuit breaker open"};let n=await this.sendWithRetries(i,s);return n.success?this.circuitBreaker.onSuccess():n.finalStatusCode&&n.finalStatusCode>=500&&this.circuitBreaker.onFailure(),n.success&&this.logAuditRecord({timestamp:new Date().toISOString(),request_id:s,tenant_id:i.tenant_id,type:i.type,payload_hash:i.payload_hash,status_code:n.finalStatusCode||200,attempt:n.attempts,duration_ms:Date.now()-a,bytes:JSON.stringify(i).length}),{...n,requestId:s}}catch(e){return console.error(`‚ùå Webhook send failed [${s}]:`,e),{success:!1,requestId:s,attempts:0,error:e instanceof Error?e.message:String(e)}}}getMetrics(){return{...n.getMetrics(),circuit_breaker:this.circuitBreaker.getState(),audit_records:o.auditLog.length}}async sendWithRetries(e,t){let s;let r=0,a="";for(;r<5;){r++;let i=Date.now();try{let o=await this.makeHttpRequest(e,t,r),c=Date.now()-i;if(n.recordLatency(c),o.ok)return n.recordSuccess(),console.log(`‚úÖ Webhook sent [${t}] (${c}ms, attempt ${r})`),{success:!0,attempts:r,finalStatusCode:o.status};if(s=o.status,429===o.status){let e=o.headers.get("Retry-After"),s=e?1e3*parseInt(e):500*Math.pow(2,r-1);if(console.warn(`‚è∞ Rate limited [${t}] - waiting ${s}ms (attempt ${r}/5)`),n.recordRetry(),r<5){await this.sleep(s);continue}}if(o.status>=500){let e=500*Math.pow(2,r-1);if(a=`HTTP ${o.status}: ${o.statusText}`,console.warn(`‚ö†Ô∏è Server error [${t}] - retrying in ${e}ms (attempt ${r}/5)`),n.recordRetry(),r<5){await this.sleep(e);continue}}if(o.status>=400&&o.status<500){let e=await o.text().catch(()=>"Unknown error");a=`HTTP ${o.status}: ${e}`,console.error(`‚ùå Client error [${t}] - not retrying: ${a}`);break}}catch(s){a=s instanceof Error?s.message:String(s);let e=500*Math.pow(2,r-1);console.warn(`‚ö†Ô∏è Network error [${t}] - retrying in ${e}ms (attempt ${r}/5): ${a}`),n.recordRetry(),r<5&&await this.sleep(e)}}return n.recordFailure(),{success:!1,attempts:r,finalStatusCode:s,error:a}}async makeHttpRequest(e,t,s){let a=JSON.stringify(e),i=new Date().toISOString(),n=(0,r.createHmac)("sha256",this.config.webhook_secret).update(a).digest("hex"),o={"Content-Type":"application/json","X-Capsight-Tenant":this.config.tenant_id,"X-Request-Id":t,"X-Timestamp":i,"X-Payload-Hash":e.payload_hash,"X-Capsight-Signature":`sha256=${n}`,"User-Agent":"CapSight-Webhook-Client/1.0.0"};return console.log(`üì§ Sending webhook [${t}] attempt ${s}: ${e.type}`),fetch(this.config.n8n_ingest_url,{method:"POST",headers:o,body:a,signal:AbortSignal.timeout(2e4)})}sleep(e){return new Promise(t=>setTimeout(t,e))}validatePayload(e){let t=[];return e.schema_version||t.push("schema_version is required"),e.type||t.push("type is required"),e.tenant_id||t.push("tenant_id is required"),e.as_of||t.push("as_of is required"),e.model?.name||t.push("model.name is required"),e.model?.version||t.push("model.version is required"),e.provenance||t.push("provenance is required"),e.model?.version&&!/^\d+\.\d+\.\d+$/.test(e.model.version)&&t.push("model.version must be valid semver"),"valuation.upsert"===e.type&&(e.inputs&&((e.inputs.vacancy_pct<0||e.inputs.vacancy_pct>.4)&&t.push("vacancy_pct must be between 0 and 0.40"),(e.inputs.cap_rate_now_pct<2||e.inputs.cap_rate_now_pct>20)&&t.push("cap_rate_now_pct must be between 2 and 20"),(e.inputs.rent_psf_yr<.5||e.inputs.rent_psf_yr>300)&&t.push("rent_psf_yr must be between 0.5 and 300")),e.current_value?.confidence!=null&&(e.current_value.confidence<0||e.current_value.confidence>1)&&t.push("confidence must be between 0 and 1")),{valid:0===t.length,errors:t}}adjustForStaleness(e){let t=new Date,s=!1,r=this.daysBetween(new Date(e.provenance.macro.as_of),t),a=this.daysBetween(new Date(e.provenance.fundamentals.as_of),t),i=this.daysBetween(new Date(e.provenance.comps.as_of),t);if(r>this.config.freshness_macro_days&&(s=!0),a>this.config.freshness_fundamentals_days&&(s=!0),i>this.config.freshness_comps_days&&(s=!0),s&&"valuation.upsert"===e.type){let t={...e};return t.status="STALE_DATA",t.current_value.confidence=Math.max(0,t.current_value.confidence-.2),t.forecast_12m.confidence=Math.max(0,t.forecast_12m.confidence-.2),t}return e}daysBetween(e,t){return Math.floor(Math.abs(t.getTime()-e.getTime())/864e5)}addPayloadHash(e){let t=JSON.stringify(e),s=(0,r.createHash)("sha256").update(t).digest("hex");return{...e,payload_hash:s}}logAuditRecord(e){o.auditLog.push(e),o.auditLog.length>1e4&&o.auditLog.shift(),console.log(`üìã Webhook audit [${e.request_id}]: ${e.type} | ${e.status_code} | ${e.duration_ms}ms | ${e.bytes}B`)}}let c=null;function u(){return c||(c=new o),c}},7153:(e,t)=>{var s;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return s}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(s||(s={}))},1802:(e,t,s)=>{e.exports=s(145)}};
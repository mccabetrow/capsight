"use strict";(()=>{var e={};e.id=911,e.ids=[911],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},2883:(e,t,a)=>{a.r(t),a.d(t,{config:()=>_,default:()=>l,routeModule:()=>h});var s={};a.r(s),a.d(s,{default:()=>c});var r=a(1802),o=a(7153),i=a(6249),n=a(8480);async function c(e,t){if("GET"!==e.method)return t.status(405).json({error:"Method not allowed"});try{console.log("\uD83E\uDE7A Health check: data sources");let e=(0,n.c)(),a={cache_hit_ratio_24h:.75,cache_hit_ratio_1h:.8,total_requests_24h:1500,macro_breaker_failures:0,supabase_breaker_failures:0,macro_latency_p50:250,macro_latency_p95:500,supabase_latency_p50:150,supabase_latency_p95:300},{freshness:s}=await e.getMacroData(),{data:r,freshness:o}=await e.getMarketFundamentals("dallas"),{data:i,freshness:c}=await e.getComparableSales("dallas",5),l="HEALTHY";s.is_fresh&&o.is_fresh&&c.is_fresh||(l="DEGRADED"),(!a||2>(i?.length||0))&&(l="DOWN");let _={status:l,timestamp:new Date().toISOString(),cache:{status:a.cache_hit_ratio_24h>.5?"HEALTHY":"DEGRADED",hit_ratio_24h:a.cache_hit_ratio_24h,hit_ratio_1h:a.cache_hit_ratio_1h,total_requests_24h:a.total_requests_24h},circuit_breakers:{macro:{state:a.macro_breaker_failures<5?"CLOSED":"OPEN",failures:a.macro_breaker_failures},supabase:{state:a.supabase_breaker_failures<5?"CLOSED":"OPEN",failures:a.supabase_breaker_failures}},latencies:{macro_p50:a.macro_latency_p50||0,macro_p95:a.macro_latency_p95||0,supabase_p50:a.supabase_latency_p50||0,supabase_p95:a.supabase_latency_p95||0},data_freshness:{macro:{last_updated:new Date().toISOString().split("T")[0],is_fresh:s.is_fresh,days_old:s.days_old},fundamentals:{markets_with_fresh_data:r?1:0,oldest_data_days:o.days_old},comps:{total_recent_comps:i?.length||0,oldest_comp_days:c.days_old}},system:{node_version:process.version,env_validated:!0,memory_usage_mb:Math.round(process.memoryUsage().heapUsed/1024/1024)}};return"DOWN"===l?t.status(503):t.status(200),t.setHeader("Cache-Control","no-cache, must-revalidate"),t.setHeader("X-Health-Status",l),t.json(_)}catch(e){return console.error("❌ Health check failed:",e),t.status(503).json({error:`Health check failed: ${e instanceof Error?e.message:"Unknown error"}`})}}let l=(0,i.l)(s,"default"),_=(0,i.l)(s,"config"),h=new r.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/health/data-v2",pathname:"/api/health/data-v2",bundlePath:"",filename:""},userland:s})},5331:(e,t,a)=>{a.d(t,{S:()=>o});class s extends Error{constructor(e){super(`Environment validation failed: ${e}`),this.name="ValidationError"}}let r=null;function o(){return r||(r=function(){let e,t;let a=[],r=process.version;for(let[e,t]of(r.startsWith("v20.")||a.push(`Node.js version must be 20.x, got ${r}`),Object.entries({N8N_INGEST_URL:"Webhook endpoint URL",WEBHOOK_SECRET:"Webhook HMAC secret",FRED_API_KEY:"FRED API key for macro data",NEXT_PUBLIC_SUPABASE_URL:"Supabase project URL",NEXT_PUBLIC_SUPABASE_ANON_KEY:"Supabase anonymous key"})))process.env[e]||a.push(`${e} is required (${t})`);let o=(e,t)=>{let s=process.env[e];if(!s)return t;let r=parseInt(s,10);return isNaN(r)?(a.push(`${e} must be a number, got "${s}"`),t):r},i=process.env.N8N_INGEST_URL||"";i&&!i.startsWith("https://")&&a.push("N8N_INGEST_URL must be HTTPS");let n=process.env.WEBHOOK_SECRET||"";if(n&&n.length<16&&a.push("WEBHOOK_SECRET must be at least 16 characters"),a.length>0)throw console.error("❌ Environment validation failed:"),a.forEach(e=>console.error(`   - ${e}`)),new s(a.join("; "));let c={node_version:r,n8n_ingest_url:i,webhook_secret:n,tenant_id:(e="CAPSIGHT_TENANT_ID",t="demo",process.env[e]||t),fred_api_key:process.env.FRED_API_KEY,supabase_url:"https://azwkiifefkwewruyplcj.supabase.co",supabase_anon_key:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6d2tpaWZlZmt3ZXdydXlwbGNqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU4Mzg2ODgsImV4cCI6MjA3MTQxNDY4OH0.kURMn0Ya-eQhYblA5dN3mFSIia-VoipcMrGhjIVEBz8",supabase_service_role_key:process.env.SUPABASE_SERVICE_ROLE_KEY,cache_ttl_macro_minutes:o("CACHE_TTL_MACRO_MINUTES",30),freshness_macro_days:o("FRESHNESS_MACRO_DAYS",7),freshness_fundamentals_days:o("FRESHNESS_FUNDAMENTALS_DAYS",90),freshness_comps_days:o("FRESHNESS_COMPS_DAYS",180),circuit_breaker_failure_threshold:o("CIRCUIT_BREAKER_FAILURE_THRESHOLD",3),circuit_breaker_timeout_minutes:o("CIRCUIT_BREAKER_TIMEOUT_MINUTES",2)};return console.log("✅ Environment validation passed"),console.log(`   Node.js: ${c.node_version}`),console.log(`   Tenant: ${c.tenant_id}`),console.log(`   Webhook: ${c.n8n_ingest_url.substring(0,50)}...`),c}()),r}},8480:(e,t,a)=>{a.d(t,{c:()=>l});var s=a(2885),r=a(5331);class o extends Error{constructor(e){super(e),this.name="CircuitBreakerError"}}class i{constructor(e,t){this.threshold=e,this.timeout=t,this.failures=0,this.lastFailureTime=null,this.state="CLOSED"}canExecute(){return"CLOSED"===this.state||"OPEN"!==this.state||!!(this.lastFailureTime&&Date.now()-this.lastFailureTime>this.timeout)&&(this.state="HALF_OPEN",!0)}onSuccess(){this.failures=0,this.state="CLOSED",this.lastFailureTime=null}onFailure(){this.failures++,this.lastFailureTime=Date.now(),this.failures>=this.threshold&&(this.state="OPEN")}getState(){return{state:this.state,failures:this.failures,lastFailureTime:this.lastFailureTime}}}class n{constructor(){this.macroCache=null,this.config=(0,r.S)(),this.circuitBreaker=new i(this.config.circuit_breaker_failure_threshold,6e4*this.config.circuit_breaker_timeout_minutes),this.supabase=(0,s.createClient)(this.config.supabase_url,this.config.supabase_service_role_key||this.config.supabase_anon_key)}async getMacroData(){let e=Date.now(),t=6e4*this.config.cache_ttl_macro_minutes;if(this.macroCache&&e<this.macroCache.expiry){let t=Math.floor((e-new Date(this.macroCache.data.fetched_at).getTime())/864e5);return{data:this.macroCache.data,provenance:{source:"FRED",as_of:this.macroCache.data.fetched_at.split("T")[0],from_cache:!0},freshness:{is_fresh:t<=this.config.freshness_macro_days,days_old:t}}}if(!this.circuitBreaker.canExecute())throw console.warn("⚡ Macro data circuit breaker is OPEN - using fallback"),new o("Macro data circuit breaker is open");try{console.log("\uD83C\uDF10 Fetching live macro data from FRED...");let a=await this.fetchFromFredWithRetry();return this.macroCache={data:a,expiry:e+t},this.circuitBreaker.onSuccess(),{data:a,provenance:{source:"FRED",as_of:a.fetched_at.split("T")[0],from_cache:!1},freshness:{is_fresh:!0,days_old:0}}}catch(t){if(console.error("❌ Failed to fetch macro data:",t),this.circuitBreaker.onFailure(),this.macroCache){let t=Math.floor((e-new Date(this.macroCache.data.fetched_at).getTime())/864e5);return{data:this.macroCache.data,provenance:{source:"FRED",as_of:this.macroCache.data.fetched_at.split("T")[0],from_cache:!0},freshness:{is_fresh:!1,days_old:t}}}throw t}}async getMarketFundamentals(e){try{console.log(`📊 Fetching market fundamentals for ${e}...`);let{data:t,error:a}=await this.supabase.from("market_fundamentals").select("*").eq("market_slug",e.toLowerCase()).order("last_updated",{ascending:!1}).limit(1).single();if(a||!t)return console.error(`❌ No market fundamentals found for ${e}:`,a),{data:null,provenance:{source:"Supabase:market_fundamentals",as_of:new Date().toISOString().split("T")[0],from_cache:!1},freshness:{is_fresh:!1,days_old:999}};let s=new Date(t.last_updated),r=Math.floor((Date.now()-s.getTime())/864e5);return{data:t,provenance:{source:"Supabase:market_fundamentals",as_of:s.toISOString().split("T")[0],from_cache:!1},freshness:{is_fresh:r<=this.config.freshness_fundamentals_days,days_old:r}}}catch(e){throw console.error("❌ Failed to fetch market fundamentals:",e),e}}async getComparableSales(e,t=15){try{console.log(`🏢 Fetching comparable sales for ${e}...`);let a=new Date;a.setMonth(a.getMonth()-6);let{data:s,error:r}=await this.supabase.from("comps").select("*").eq("market_slug",e.toLowerCase()).gte("sale_date",a.toISOString().split("T")[0]).not("cap_rate_pct","is",null).not("price_per_sf_usd","is",null).order("sale_date",{ascending:!1}).limit(t);if(r)throw console.error(`❌ Error fetching comps for ${e}:`,r),r;let o=s||[],i=o.length>0?new Date(Math.max(...o.map(e=>new Date(e.sale_date).getTime()))):new Date,n=Math.floor((Date.now()-i.getTime())/864e5);return{data:o,provenance:{source:"Supabase:comps",as_of:i.toISOString().split("T")[0],from_cache:!1},freshness:{is_fresh:n<=this.config.freshness_comps_days,days_old:n}}}catch(e){throw console.error("❌ Failed to fetch comparable sales:",e),e}}getCircuitBreakerStatus(){return this.circuitBreaker.getState()}async fetchFromFredWithRetry(){for(let e=0;e<3;e++)try{let e=`https://api.stlouisfed.org/fred/series/observations?series_id=DFF&api_key=${this.config.fred_api_key}&file_type=json&limit=1&sort_order=desc`,t=await fetch(e,{signal:AbortSignal.timeout(1e4)});if(!t.ok)throw Error(`FRED DFF API error: ${t.status}`);let a=await t.json(),s=parseFloat(a.observations[0].value),r=`https://api.stlouisfed.org/fred/series/observations?series_id=GS10&api_key=${this.config.fred_api_key}&file_type=json&limit=1&sort_order=desc`,o=await fetch(r,{signal:AbortSignal.timeout(1e4)});if(!o.ok)throw Error(`FRED GS10 API error: ${o.status}`);let i=await o.json(),n=parseFloat(i.observations[0].value),c=`https://api.stlouisfed.org/fred/series/observations?series_id=UNRATE&api_key=${this.config.fred_api_key}&file_type=json&limit=1&sort_order=desc`,l=await fetch(c,{signal:AbortSignal.timeout(1e4)}),_=await l.json(),h=parseFloat(_.observations[0].value);return{fed_funds_rate:s,ten_year_treasury:n,unemployment_rate:h,fetched_at:new Date().toISOString()}}catch(a){if(console.warn(`⚠️ FRED fetch attempt ${e+1} failed:`,a),2===e)throw a;let t=500*Math.pow(2,e);await new Promise(e=>setTimeout(e,t))}throw Error("All FRED fetch attempts failed")}}let c=null;function l(){return c||(c=new n),c}},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=2883);module.exports=a})();
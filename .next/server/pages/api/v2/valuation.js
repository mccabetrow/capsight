"use strict";(()=>{var e={};e.id=604,e.ids=[604],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},3513:(e,a,t)=>{t.r(a),t.d(a,{config:()=>g,default:()=>f,routeModule:()=>v});var r={};t.r(r),t.d(r,{default:()=>m});var s=t(1802),n=t(7153),o=t(6249),i=t(4770),c=t(5331),_=t(8480);let l={alpha_macro_spread:.65,beta_vacancy:.85,gamma_absorption:.25,max_change_bps:150,model_version:"1.0.0"};class u{static calculateNOI(e,a,t,r){if(e<=0||a<=0||r<0||r>.4)throw Error("Invalid NOI calculation inputs");return Math.max(0,(a-t)*e*(1-r))}static calculateCurrentValue(e,a){if(e<=0||a<=0||a>20)throw Error("Invalid current value calculation inputs");return e/(a/100)}static calculateFutureNOI(e,a,t){if(e<=0||t<0)throw Error("Invalid future NOI calculation inputs");return e*Math.pow(1+Math.max(-10,Math.min(20,a))/100,t)}static forecastCapRate(e){let{alpha_macro_spread:a,beta_vacancy:t,gamma_absorption:r,max_change_bps:s}=l,n=e.macro_spread_change_bps/100*a+e.vacancy_change_bps/100*t-r*Math.max(0,e.absorption_to_deliveries_ratio-1)*100;return n=Math.max(-s,Math.min(s,n)),Math.max(2,Math.min(20,e.current_cap_rate_pct+n/100))}static calculateFutureValue(e,a){return u.calculateCurrentValue(e,a)}static performDualEngineCheck(e,a,t){let r;if(0===a.length)return{income_approach_value:e,sales_comp_value:e,disagreement_pct:0,recommended_value:e,warning:"no_comps_available"};let s=a.map(e=>e.price_per_sf_usd),n=s.sort((e,a)=>e-a)[Math.floor(s.length/2)]*t,o=Math.abs(e-n)/e,i=e;return o>.15&&(i=.6*e+.4*n,r="engine_disagreement"),{income_approach_value:e,sales_comp_value:n,disagreement_pct:100*o,recommended_value:i,warning:r}}static calculateConfidence(e){let a=.85;return e.comp_count<3?a-=.25:e.comp_count>=5&&(a+=.1),e.macro_freshness_days>7&&(a-=.15),e.fundamentals_freshness_days>90&&(a-=.2),e.comps_freshness_days>180&&(a-=.15),e.dual_engine_disagreement_pct>15&&(a-=.15),e.cap_rate_variance_from_market>1.5&&(a-=.1),Math.max(.1,Math.min(1,a))}static calculateValuationRange(e,a){let t=(1-a)*.3+.1;return{low:Math.round(e*(1-t)),high:Math.round(e*(1+t))}}static calculateFullValuation(e,a,t){let r=this.calculateNOI(e.building_sf,e.rent_psf_yr,e.opex_psf_yr,e.vacancy_pct),s=this.calculateCurrentValue(r,e.cap_rate_now_pct),n=this.forecastCapRate({current_cap_rate_pct:e.cap_rate_now_pct,macro_spread_change_bps:e.cap_rate_spread_change_bps,vacancy_change_bps:e.vacancy_change_bps,absorption_to_deliveries_ratio:e.absorption_to_deliveries_ratio}),o=this.calculateFutureNOI(r,e.rent_growth_ann_pct,1),i=this.calculateFutureValue(o,n),c=this.performDualEngineCheck(s,a,e.building_sf),_=a.length>0?a.reduce((e,a)=>e+a.cap_rate_pct,0)/a.length:e.cap_rate_now_pct,l=Math.abs(e.cap_rate_now_pct-_),u={data_freshness:Math.max(.5,1-Math.max(t.macro_days,t.fundamentals_days,t.comps_days)/180),comp_count:Math.min(1,a.length/5),calculation_certainty:Math.max(.3,1-c.disagreement_pct/100)};return this.calculateConfidence({comp_count:a.length,macro_freshness_days:t.macro_days,fundamentals_freshness_days:t.fundamentals_days,comps_freshness_days:t.comps_days,dual_engine_disagreement_pct:c.disagreement_pct,cap_rate_variance_from_market:l}),{noi_current:r,noi_future_12m:o,current_value:Math.round(c.recommended_value),future_value_12m:Math.round(i),cap_rate_forecast_12m:Math.round(100*n)/100,price_per_sf:Math.round(c.recommended_value/e.building_sf),confidence_factors:u}}static getModelMetadata(){return{name:"valuation-blend",version:"1.0.0",cap_rate_model:l,formulas:{noi:"(rent_psf_yr - opex_psf_yr) * building_sf * (1 - vacancy_pct)",current_value:"NOI / (cap_rate_now_pct / 100)",future_noi:"NOI * (1 + rent_growth_ann)^t",future_value:"NOI_future / (cap_rate_future / 100)",cap_rate_forecast:"cap_t + Œ±*ŒîMacroSpread + Œ≤*ŒîVacancy - Œ≥*AbsorptionToDeliveries"}}}}var d=t(8916);async function m(e,a){let t=Date.now(),r=(0,i.randomUUID)();try{(0,c.S)()}catch(e){return console.error("‚ùå Environment validation failed:",e),a.status(500).json({error:"Server configuration error",request_id:r,calculation_time_ms:Date.now()-t})}if("POST"!==e.method)return a.status(405).json({error:"Method not allowed",request_id:r});try{let s;console.log(`üöÄ Valuation request started [${r}]`);let{market:n,building_sf:o,noi_annual:i,debug:c}=e.body;if(!n||!o)return a.status(400).json({error:"Missing required fields: market, building_sf",request_id:r,calculation_time_ms:Date.now()-t});if(o<1e3||o>1e7)return a.status(400).json({error:"building_sf must be between 1,000 and 10,000,000",request_id:r,calculation_time_ms:Date.now()-t});console.log(`üìä Processing [${r}]: ${n}, ${o} SF${i?`, NOI $${i}`:""}`);let l=(0,_.c)(),{data:d,provenance:m,freshness:f}=await l.getMacroData();if(!d)return console.error(`‚ùå No macro data available [${r}]`),a.status(422).json({error:"INSUFFICIENT_DATA: No macro data available",request_id:r,calculation_time_ms:Date.now()-t});let{data:g,provenance:v,freshness:y}=await l.getMarketFundamentals(n);if(!g)return console.warn(`‚ö†Ô∏è No market fundamentals for ${n} [${r}]`),await h(r,{reason:["no_macro_data"],details:{comp_count:0},macro:m,fundamentals:{source:"none",as_of:new Date().toISOString().split("T")[0]},comps:{source:"none",as_of:new Date().toISOString().split("T")[0]}}),a.status(422).json({error:"INSUFFICIENT_DATA: No market fundamentals available for this market",request_id:r,calculation_time_ms:Date.now()-t});let{data:w,provenance:b,freshness:F}=await l.getComparableSales(n,15),S=w?.length||0;console.log(`üßÆ Calculating valuation [${r}]...`);let M=i;if(!M&&g&&(M=u.calculateNOI(o,g.avg_asking_rent_psf_yr_nnn,.3*g.avg_asking_rent_psf_yr_nnn,g.vacancy_rate_pct/100)),!M||M<=0)return await h(r,{reason:["invalid_inputs"],details:{comp_count:S},macro:m,fundamentals:v,comps:b}),a.status(422).json({error:"INSUFFICIENT_DATA: Cannot determine NOI for valuation",request_id:r,calculation_time_ms:Date.now()-t});let k=g.avg_cap_rate_pct,D=Math.max(0,(d.fed_funds_rate-2)*.1),I=Math.max(0,(d.ten_year_treasury-d.fed_funds_rate-2)*.05);k+=D+I;let E=u.calculateCurrentValue(M,k),T=g.rent_growth_yoy_pct||2.5,C=u.calculateFutureNOI(M,T,1),$=k-.1,x=u.calculateFutureValue(C,$),A=u.performDualEngineCheck(E,w||[],o),N=u.calculateConfidence({comp_count:S,macro_freshness_days:f.days_old,fundamentals_freshness_days:y.days_old,comps_freshness_days:F.days_old,dual_engine_disagreement_pct:A.disagreement_pct,cap_rate_variance_from_market:0}),O=u.calculateValuationRange(A.recommended_value,N),q=u.calculateValuationRange(x,Math.max(.3,N-.15)),R="FRESH";f.is_fresh&&y.is_fresh&&F.is_fresh||(R="STALE_DATA"),(S<2||N<.4)&&(R="INSUFFICIENT_DATA");let j=[`Market cap rate: ${g.avg_cap_rate_pct.toFixed(2)}%`,`Fed funds adjustment: +${(100*D).toFixed(0)}bps`,`Treasury spread adjustment: +${(100*I).toFixed(0)}bps`,`${S} comparable sales`,`NOI: $${Math.round(M).toLocaleString()}`,`Rent growth: ${T.toFixed(1)}% annually`];"engine_disagreement"===A.warning&&j.push(`‚ö†Ô∏è Income vs Sales disagreement: ${A.disagreement_pct.toFixed(1)}%`);let P={estimated_value:Math.round(A.recommended_value),estimated_value_range:O,cap_rate_applied:Math.round(100*k)/100,cap_rate_forecast_12m:Math.round(100*$)/100,price_per_sf:Math.round(A.recommended_value/o),forecast_12m:{point:Math.round(x),low:q.low,high:q.high,confidence:Math.max(.3,N-.15)},confidence_score:Math.round(100*N)/100,valuation_status:R,provenance:{macro:m,fundamentals:v,comps:b},freshness_summary:{macro:{status:f.is_fresh?"FRESH":"STALE",days_old:f.days_old},fundamentals:{status:y.is_fresh?"FRESH":"STALE",days_old:y.days_old},comps:{status:F.is_fresh?"FRESH":"STALE",days_old:F.days_old}},derived:{noi_current:Math.round(M),noi_future_12m:Math.round(C),comp_count:S,dual_engine_disagreement_pct:A.disagreement_pct,model_version:u.getModelMetadata().version},drivers:j,calculated_at:new Date().toISOString(),calculation_time_ms:Date.now()-t,request_id:r};try{s=await p(r,P,{building_sf:o,market:n,asset_type:"office",rent_psf_yr:g.avg_asking_rent_psf_yr_nnn,opex_psf_yr:.3*g.avg_asking_rent_psf_yr_nnn,vacancy_pct:g.vacancy_rate_pct/100,cap_rate_now_pct:k,cap_rate_qoq_delta_bps:0})}catch(e){console.error(`‚ùå Webhook failed [${r}]:`,e)}return c&&(P.debug={macro_raw:d,fundamentals_raw:g,comps_raw:w||[],math_breakdown:{current_noi:M,fed_funds_premium:D,spread_risk:I,adjusted_cap_rate:k,income_approach_value:E,sales_comp_value:A.sales_comp_value,recommended_value:A.recommended_value},webhook_result:s}),console.log(`‚úÖ Valuation complete [${r}]: $${P.estimated_value.toLocaleString()} (${P.confidence_score} confidence)`),a.setHeader("Cache-Control","no-cache, must-revalidate"),a.setHeader("X-Calculation-Time",`${P.calculation_time_ms}ms`),a.setHeader("X-Request-Id",r),a.status(200).json(P)}catch(e){return console.error(`‚ùå Valuation API error [${r}]:`,e),a.status(500).json({error:`Valuation failed: ${e instanceof Error?e.message:"Unknown error"}`,request_id:r,calculation_time_ms:Date.now()-t})}}async function p(e,a,t){let r=(0,d.z)(),s={schema_version:"1.0",type:"valuation.upsert",tenant_id:(0,c.S)().tenant_id,as_of:new Date().toISOString().split("T")[0],model:{name:"valuation-blend",version:"1.0.0"},provenance:a.provenance,address:`${t.building_sf} SF Building, ${t.market.toUpperCase()} Market`,geo:{lat:32.7767,lon:-96.797,market:t.market.toUpperCase(),submarket:"Unknown"},property_snapshot:{building_sf:t.building_sf,year_built:2020},inputs:{asset_type:t.asset_type,rent_psf_yr:t.rent_psf_yr,opex_psf_yr:t.opex_psf_yr,vacancy_pct:t.vacancy_pct,cap_rate_now_pct:t.cap_rate_now_pct,cap_rate_qoq_delta_bps:t.cap_rate_qoq_delta_bps},current_value:{point:a.estimated_value,low:a.estimated_value_range.low,high:a.estimated_value_range.high,confidence:a.confidence_score},forecast_12m:a.forecast_12m,drivers:a.drivers};return"STALE_DATA"===a.valuation_status&&(s.status="STALE_DATA"),a.derived.dual_engine_disagreement_pct&&a.derived.dual_engine_disagreement_pct>15&&(s.warning="engine_disagreement"),await r.send(s,e)}async function h(e,a){let t=(0,d.z)(),r={schema_version:"1.0",type:"valuation.insufficient",tenant_id:(0,c.S)().tenant_id,as_of:new Date().toISOString().split("T")[0],model:{name:"valuation-blend",version:"1.0.0"},provenance:{macro:a.macro,fundamentals:a.fundamentals,comps:a.comps},address:"Insufficient Data Property",reason:a.reason,details:a.details,status:"INSUFFICIENT_DATA"};return await t.send(r,e)}let f=(0,o.l)(r,"default"),g=(0,o.l)(r,"config"),v=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/v2/valuation",pathname:"/api/v2/valuation",bundlePath:"",filename:""},userland:r})},8480:(e,a,t)=>{t.d(a,{c:()=>_});var r=t(2885),s=t(5331);class n extends Error{constructor(e){super(e),this.name="CircuitBreakerError"}}class o{constructor(e,a){this.threshold=e,this.timeout=a,this.failures=0,this.lastFailureTime=null,this.state="CLOSED"}canExecute(){return"CLOSED"===this.state||"OPEN"!==this.state||!!(this.lastFailureTime&&Date.now()-this.lastFailureTime>this.timeout)&&(this.state="HALF_OPEN",!0)}onSuccess(){this.failures=0,this.state="CLOSED",this.lastFailureTime=null}onFailure(){this.failures++,this.lastFailureTime=Date.now(),this.failures>=this.threshold&&(this.state="OPEN")}getState(){return{state:this.state,failures:this.failures,lastFailureTime:this.lastFailureTime}}}class i{constructor(){this.macroCache=null,this.config=(0,s.S)(),this.circuitBreaker=new o(this.config.circuit_breaker_failure_threshold,6e4*this.config.circuit_breaker_timeout_minutes),this.supabase=(0,r.createClient)(this.config.supabase_url,this.config.supabase_service_role_key||this.config.supabase_anon_key)}async getMacroData(){let e=Date.now(),a=6e4*this.config.cache_ttl_macro_minutes;if(this.macroCache&&e<this.macroCache.expiry){let a=Math.floor((e-new Date(this.macroCache.data.fetched_at).getTime())/864e5);return{data:this.macroCache.data,provenance:{source:"FRED",as_of:this.macroCache.data.fetched_at.split("T")[0],from_cache:!0},freshness:{is_fresh:a<=this.config.freshness_macro_days,days_old:a}}}if(!this.circuitBreaker.canExecute())throw console.warn("‚ö° Macro data circuit breaker is OPEN - using fallback"),new n("Macro data circuit breaker is open");try{console.log("\uD83C\uDF10 Fetching live macro data from FRED...");let t=await this.fetchFromFredWithRetry();return this.macroCache={data:t,expiry:e+a},this.circuitBreaker.onSuccess(),{data:t,provenance:{source:"FRED",as_of:t.fetched_at.split("T")[0],from_cache:!1},freshness:{is_fresh:!0,days_old:0}}}catch(a){if(console.error("‚ùå Failed to fetch macro data:",a),this.circuitBreaker.onFailure(),this.macroCache){let a=Math.floor((e-new Date(this.macroCache.data.fetched_at).getTime())/864e5);return{data:this.macroCache.data,provenance:{source:"FRED",as_of:this.macroCache.data.fetched_at.split("T")[0],from_cache:!0},freshness:{is_fresh:!1,days_old:a}}}throw a}}async getMarketFundamentals(e){try{console.log(`üìä Fetching market fundamentals for ${e}...`);let{data:a,error:t}=await this.supabase.from("market_fundamentals").select("*").eq("market_slug",e.toLowerCase()).order("last_updated",{ascending:!1}).limit(1).single();if(t||!a)return console.error(`‚ùå No market fundamentals found for ${e}:`,t),{data:null,provenance:{source:"Supabase:market_fundamentals",as_of:new Date().toISOString().split("T")[0],from_cache:!1},freshness:{is_fresh:!1,days_old:999}};let r=new Date(a.last_updated),s=Math.floor((Date.now()-r.getTime())/864e5);return{data:a,provenance:{source:"Supabase:market_fundamentals",as_of:r.toISOString().split("T")[0],from_cache:!1},freshness:{is_fresh:s<=this.config.freshness_fundamentals_days,days_old:s}}}catch(e){throw console.error("‚ùå Failed to fetch market fundamentals:",e),e}}async getComparableSales(e,a=15){try{console.log(`üè¢ Fetching comparable sales for ${e}...`);let t=new Date;t.setMonth(t.getMonth()-6);let{data:r,error:s}=await this.supabase.from("comps").select("*").eq("market_slug",e.toLowerCase()).gte("sale_date",t.toISOString().split("T")[0]).not("cap_rate_pct","is",null).not("price_per_sf_usd","is",null).order("sale_date",{ascending:!1}).limit(a);if(s)throw console.error(`‚ùå Error fetching comps for ${e}:`,s),s;let n=r||[],o=n.length>0?new Date(Math.max(...n.map(e=>new Date(e.sale_date).getTime()))):new Date,i=Math.floor((Date.now()-o.getTime())/864e5);return{data:n,provenance:{source:"Supabase:comps",as_of:o.toISOString().split("T")[0],from_cache:!1},freshness:{is_fresh:i<=this.config.freshness_comps_days,days_old:i}}}catch(e){throw console.error("‚ùå Failed to fetch comparable sales:",e),e}}getCircuitBreakerStatus(){return this.circuitBreaker.getState()}async fetchFromFredWithRetry(){for(let e=0;e<3;e++)try{let e=`https://api.stlouisfed.org/fred/series/observations?series_id=DFF&api_key=${this.config.fred_api_key}&file_type=json&limit=1&sort_order=desc`,a=await fetch(e,{signal:AbortSignal.timeout(1e4)});if(!a.ok)throw Error(`FRED DFF API error: ${a.status}`);let t=await a.json(),r=parseFloat(t.observations[0].value),s=`https://api.stlouisfed.org/fred/series/observations?series_id=GS10&api_key=${this.config.fred_api_key}&file_type=json&limit=1&sort_order=desc`,n=await fetch(s,{signal:AbortSignal.timeout(1e4)});if(!n.ok)throw Error(`FRED GS10 API error: ${n.status}`);let o=await n.json(),i=parseFloat(o.observations[0].value),c=`https://api.stlouisfed.org/fred/series/observations?series_id=UNRATE&api_key=${this.config.fred_api_key}&file_type=json&limit=1&sort_order=desc`,_=await fetch(c,{signal:AbortSignal.timeout(1e4)}),l=await _.json(),u=parseFloat(l.observations[0].value);return{fed_funds_rate:r,ten_year_treasury:i,unemployment_rate:u,fetched_at:new Date().toISOString()}}catch(t){if(console.warn(`‚ö†Ô∏è FRED fetch attempt ${e+1} failed:`,t),2===e)throw t;let a=500*Math.pow(2,e);await new Promise(e=>setTimeout(e,a))}throw Error("All FRED fetch attempts failed")}}let c=null;function _(){return c||(c=new i),c}}};var a=require("../../../webpack-api-runtime.js");a.C(e);var t=e=>a(a.s=e),r=a.X(0,[750],()=>t(3513));module.exports=r})();
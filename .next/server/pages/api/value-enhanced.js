"use strict";(()=>{var e={};e.id=415,e.ids=[415],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},3280:(e,t,a)=>{a.r(t),a.d(t,{config:()=>c,default:()=>l,routeModule:()=>_});var r={};a.r(r),a.d(r,{default:()=>d});var n=a(1802),s=a(7153),o=a(6249),i=a(6137);async function d(e,t){if("POST"!==e.method)return t.status(405).json({error:"Method not allowed"});try{let{market_slug:a,noi_annual:r,building_sf:n,submarket:s}=e.body;if(!a||!r||!n)return t.status(400).json({error:"Missing required fields: market_slug, noi_annual, building_sf"});let o=(0,i.k)(),{data:d,error:l}=await o.from("market_status").select("enabled, reason, updated_at").eq("market_slug",a).single();if(l&&"PGRST116"!==l.code)return console.error("Market status error:",l),t.status(500).json({error:"Database query failed"});if(d&&!d.enabled)return t.status(422).json({error:`Market '${a}' temporarily disabled: ${d.reason||"Data quality issues"}`,retry_after:new Date(Date.now()+864e5).toISOString()});let{data:c,error:_}=await o.from("mv_comps_recent_12m").select("*").eq("market_slug",a).order("sale_date",{ascending:!1});if(_)return console.error("Supabase error:",_),t.status(500).json({error:"Database query failed"});if(!c||0===c.length)return t.status(404).json({error:"No comparable sales found for this market"});let{data:h}=await o.from("latest_accuracy").select("*").eq("market_slug",a).single(),p=function(e,t,a){let r=new Date;return e.map(e=>{let n=new Date(e.sale_date),s=(r.getTime()-n.getTime())/2630016e3,o=Math.exp(-Math.log(2)*s/12),i=Math.exp(-0)*(a&&e.submarket===a?2:1),d=Math.exp(-.5*Math.pow((Math.log(e.building_sf)-Math.log(t))/.35,2)),u=e.cap_rate_pct;return{...e,months_since:s,distance_mi:0,weight_recency:o,weight_distance:i,weight_size:d,weight_combined:o*i*d,adjusted_cap_rate:u}})}(c,n,s),m=p.length<8?{useFallback:!0,reason:"Low sample size",widthAdjustment:.05}:u(p)>.015?{useFallback:!1,reason:"High dispersion",widthAdjustment:.025}:p.reduce((e,t)=>e+t.months_since,0)/p.length>18?{useFallback:!1,reason:"Stale data",widthAdjustment:.045}:{useFallback:!1,widthAdjustment:0},f=function(e,t){if(0===e.length)return 6.5;let a=e.reduce((e,t)=>e+t.weight_combined,0);e.forEach(e=>e.weight_combined/=a);let r=e.sort((e,t)=>e.adjusted_cap_rate-t.adjusted_cap_rate),n=0;for(let e of r)if((n+=e.weight_combined)>=.5)return e.adjusted_cap_rate;return r[Math.floor(r.length/2)].adjusted_cap_rate}(p,0),g=Math.round(r/(f/100)),b=function(e,t){let a=.1,r="\xb110% (default)",n="bad";if(e&&e.ape_q80){let s=e.mape<=.1&&e.rmse_bps<=50&&e.coverage80>=.78&&e.coverage80<=.82,o=Math.max(.05,e.ape_q80);a=o+t.widthAdjustment,s&&o<=.05?(r="\xb15% (SLA met)",n="ok"):o<=.08?(r=`\xb1${Math.round(100*a)}% (calibrated)`,n="warn"):(r=`\xb1${Math.round(100*a)}% (low data/high dispersion)`,n="bad")}return{width_pct:a,label:r,status:n}}(h,m),w=[Math.round(g*(1-b.width_pct)),Math.round(g*(1+b.width_pct))],j=p.sort((e,t)=>t.weight_combined-e.weight_combined).slice(0,5).map(e=>({address_masked:function(e){let t=e.split(" ");return t.length>2?`${t[0]} ****** ${t[t.length-1]}`:`****** ${t[t.length-1]}`}(e.address),sale_date:e.sale_date,adjusted_cap_rate:e.adjusted_cap_rate,weight:Math.round(100*e.weight_combined)/100,distance_mi:Math.round(10*e.distance_mi)/10})),M=p.length>0?Math.max(...p.map(e=>e.months_since)):0,P=1e4*u(p),A={valuation_usd:g,confidence_interval:w,cap_rate_pct:Math.round(100*f)/100,price_per_sf_usd:Math.round(g/n),methodology:"weighted_median_robust_v1.0",comp_count:p.length,top_comps:j,confidence_band:b,quality_indicators:{sample_size:p.length,data_freshness_months:Math.round(10*M)/10,dispersion_bps:Math.round(P),fallback_reason:m.reason}};t.status(200).json(A)}catch(e){console.error("Valuation API error:",e),t.status(500).json({error:"Internal server error"})}}function u(e){if(e.length<4)return 0;let t=e.sort((e,t)=>e.adjusted_cap_rate-t.adjusted_cap_rate).map(e=>e.adjusted_cap_rate),a=t[Math.floor(.25*t.length)];return(t[Math.floor(.75*t.length)]-a)/100}let l=(0,o.l)(r,"default"),c=(0,o.l)(r,"config"),_=new n.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/value-enhanced",pathname:"/api/value-enhanced",bundlePath:"",filename:""},userland:r})},6137:(e,t,a)=>{a.d(t,{k:()=>s});let r=require("@supabase/supabase-js"),n="https://azwkiifefkwewruyplcj.supabase.co";function s(){let e=process.env.SUPABASE_SERVICE_ROLE_KEY;return(0,r.createClient)(n,e)}(0,r.createClient)(n,"paste_your_anon_key_here")},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var a=t(t.s=3280);module.exports=a})();
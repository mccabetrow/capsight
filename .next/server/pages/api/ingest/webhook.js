"use strict";(()=>{var e={};e.id=493,e.ids=[493],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},2824:e=>{e.exports=require("next/server")},4770:e=>{e.exports=require("crypto")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},82:(e,t,a)=>{a.r(t),a.d(t,{config:()=>g,default:()=>f,routeModule:()=>v});var s={};a.r(s),a.d(s,{GET:()=>m,POST:()=>h});var r=a(1802),n=a(7153),o=a(6249),c=a(2824),i=a(4770),u=a(9122),l=a(2885);let _=process.env.WEBHOOK_SECRET||"development-secret-change-in-production";async function h(e){let t;let a=Date.now();try{let s=await e.text(),r=e.headers.get("x-signature"),n=e.headers.get("x-timestamp");if(!r||!n)return c.NextResponse.json({error:"Missing required headers: x-signature, x-timestamp"},{status:401});let o=parseInt(n),h=Math.floor(Date.now()/1e3);if(Math.abs(h-o)>300)return c.NextResponse.json({error:"Request timestamp outside acceptable window"},{status:401});let m="sha256="+(0,i.createHmac)("sha256",_).update(n+"."+s).digest("hex");if(!(0,i.timingSafeEqual)(Buffer.from(r),Buffer.from(m)))return c.NextResponse.json({error:"Invalid signature"},{status:401});let f=JSON.parse(s);t=`ingest_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,console.log(`ðŸ“¥ Processing ingest event: ${f.event_type} (${t})`);let g=function(e){let t=[];switch(e.event_type||t.push("event_type is required"),e.data&&"object"==typeof e.data||t.push("data must be a valid object"),e.source||t.push("source is required"),e.timestamp||t.push("timestamp is required"),e.event_type){case"market.fundamentals.upsert":for(let a of(e.market_slug||t.push("market_slug is required for market fundamentals"),["vacancy_rate_pct","avg_asking_rent_psf_yr_nnn","yoy_rent_growth_pct","avg_cap_rate_pct"]))a in e.data&&"number"==typeof e.data[a]||t.push(`${a} is required and must be a number`);(e.data.vacancy_rate_pct<0||e.data.vacancy_rate_pct>40)&&t.push("vacancy_rate_pct must be between 0 and 40"),(e.data.avg_cap_rate_pct<2||e.data.avg_cap_rate_pct>20)&&t.push("avg_cap_rate_pct must be between 2 and 20");break;case"comps.upsert":e.market_slug||t.push("market_slug is required for comparables"),Array.isArray(e.data.comparables)?e.data.comparables.forEach((e,a)=>{(!e.building_sf||e.building_sf<=0)&&t.push(`comparables[${a}].building_sf must be positive`),(!e.price_per_sf_usd||e.price_per_sf_usd<=0)&&t.push(`comparables[${a}].price_per_sf_usd must be positive`),e.sale_date||t.push(`comparables[${a}].sale_date is required`)}):t.push("data.comparables must be an array")}return t}(f);if(g.length>0)return c.NextResponse.json({success:!1,message:"Validation failed",validation_errors:g,ingestion_id:t},{status:400});let v=(0,l.createClient)("https://azwkiifefkwewruyplcj.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),E=(0,u.M)(),w=0,S=[];switch(f.event_type){case"market.fundamentals.upsert":w=await p(v,f),f.market_slug&&(E.invalidateCache(`fundamentals_${f.market_slug}`),S.push(`fundamentals_${f.market_slug}`));break;case"comps.upsert":w=await d(v,f),f.market_slug&&(E.invalidateCache(`comps_${f.market_slug}`),S.push(`comps_${f.market_slug}*`));break;case"macro.update":E.invalidateCache("macro_data"),S.push("macro_data"),w=1;break;default:return c.NextResponse.json({success:!1,message:`Unknown event type: ${f.event_type}`,ingestion_id:t},{status:400})}try{await v.from("ingestion_events").insert({id:t,event_type:f.event_type,market_slug:f.market_slug,source:f.source,processed_records:w,cache_invalidated:S,processing_time_ms:Date.now()-a,checksum:function(e){let t=JSON.stringify(e,Object.keys(e).sort());return(0,i.createHmac)("sha256","checksum-key").update(t).digest("hex").slice(0,16)}(f.data),created_at:new Date().toISOString()})}catch(e){console.error("Failed to log ingestion event:",e)}return console.log(`âœ… Ingestion complete: ${w} records processed (${Date.now()-a}ms)`),c.NextResponse.json({success:!0,message:`Successfully processed ${f.event_type}`,processed_records:w,cache_invalidated:S,ingestion_id:t},{status:200,headers:{"X-Processing-Time":`${Date.now()-a}ms`,"X-Ingestion-ID":t}})}catch(e){return console.error("Ingestion error:",e,t),c.NextResponse.json({success:!1,message:`Ingestion failed: ${e instanceof Error?e.message:"Unknown error"}`,ingestion_id:t},{status:500,headers:{"X-Processing-Time":`${Date.now()-a}ms`,"X-Ingestion-ID":t||"unknown"}})}}async function p(e,t){let{data:a,error:s}=await e.from("market_fundamentals").upsert({market_slug:t.market_slug,...t.data,updated_at:new Date().toISOString()},{onConflict:"market_slug",ignoreDuplicates:!1});if(s)throw Error(`Failed to upsert market fundamentals: ${s.message}`);return 1}async function d(e,t){let a=t.data.comparables.map(e=>({...e,market_slug:t.market_slug,created_at:new Date().toISOString()})),{data:s,error:r}=await e.from("v_comps_trimmed").insert(a);if(r)throw Error(`Failed to insert comparables: ${r.message}`);return a.length}async function m(e){let t=new URL(e.url).searchParams.get("id");if(!t)return c.NextResponse.json({error:"ingestion_id parameter required"},{status:400});try{let e=(0,l.createClient)("https://azwkiifefkwewruyplcj.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY),{data:a,error:s}=await e.from("ingestion_events").select("*").eq("id",t).single();if(s||!a)return c.NextResponse.json({error:"Ingestion event not found"},{status:404});return c.NextResponse.json({success:!0,event:a})}catch(e){return c.NextResponse.json({error:`Failed to retrieve ingestion status: ${e}`},{status:500})}}let f=(0,o.l)(s,"default"),g=(0,o.l)(s,"config"),v=new r.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/ingest/webhook",pathname:"/api/ingest/webhook",bundlePath:"",filename:""},userland:s})},9122:(e,t,a)=>{a.d(t,{M:()=>i});var s=a(2885);class r{set(e,t,a){let s=Date.now();this.cache.set(e,{data:t,timestamp:s,expires_at:s+a})}get(e){let t=this.cache.get(e);return!t||t.expires_at<Date.now()?(this.cache.delete(e),null):t.data}delete(e){this.cache.delete(e)}clear(){this.cache.clear()}constructor(){this.cache=new Map}}class n{constructor(e=3,t=12e4){this.failure_threshold=e,this.timeout_ms=t,this.state={state:"closed",failure_count:0}}async execute(e){if("open"===this.state.state){if(Date.now()>=(this.state.next_attempt_time||0))this.state.state="half-open";else throw Error(`Circuit breaker OPEN. Next attempt in ${Math.ceil(((this.state.next_attempt_time||0)-Date.now())/1e3)}s`)}try{let t=await e();return("half-open"===this.state.state||this.state.failure_count>0)&&(this.state={state:"closed",failure_count:0}),t}catch(e){throw this.state.failure_count++,this.state.last_failure_time=Date.now(),this.state.failure_count>=this.failure_threshold&&(this.state.state="open",this.state.next_attempt_time=Date.now()+this.timeout_ms),e}}getState(){return{...this.state}}}class o{constructor(){this.cache=new r,this.fredCircuitBreaker=new n(3,12e4),this.supabaseCircuitBreaker=new n(5,6e4),this.FRED_BASE_URL="https://api.stlouisfed.org/fred",this.MACRO_CACHE_TTL=6e4*parseInt(process.env.CACHE_TTL_MACRO_MINUTES||"30"),this.FUNDAMENTALS_CACHE_TTL=36e5*parseInt(process.env.CACHE_TTL_FUNDAMENTALS_HOURS||"24"),this.COMPS_CACHE_TTL=36e5*parseInt(process.env.CACHE_TTL_COMPS_HOURS||"24"),this.supabase=(0,s.createClient)("https://azwkiifefkwewruyplcj.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY)}async getMacroData(){let e="macro_data",t=this.cache.get(e);if(t&&t.provenance)return{data:t.data,provenance:{source:t.provenance.source,as_of:t.provenance.as_of,from_cache:!0,breaker_status:t.provenance.breaker_status}};try{let t=await this.fredCircuitBreaker.execute(async()=>{let e=await this.fetchFredSeries("DFF"),t=await this.fetchFredSeries("GS10");return{fed_funds_rate:e.value,treasury_10yr:t.value,as_of:e.date,source:"FRED"}}),a={source:"FRED",as_of:t.as_of,from_cache:!1,breaker_status:this.fredCircuitBreaker.getState().state};return this.cache.set(e,{data:t,provenance:a},this.MACRO_CACHE_TTL),{data:t,provenance:a}}catch(a){console.error("FRED API error:",a);let t=this.cache.get(e);if(t&&t.provenance)return{data:t.data,provenance:{source:t.provenance.source,as_of:t.provenance.as_of,from_cache:!0,breaker_status:this.fredCircuitBreaker.getState().state}};throw Error(`FRED API unavailable and no cached data: ${a}`)}}async fetchFredSeries(e){let t=process.env.FRED_API_KEY;if(!t)throw Error("FRED_API_KEY not configured");let a=`${this.FRED_BASE_URL}/series/observations?series_id=${e}&api_key=${t}&file_type=json&limit=1&sort_order=desc`,s=await fetch(a,{method:"GET",headers:{"User-Agent":"CapSight/1.0"},signal:AbortSignal.timeout(1e4)});if(!s.ok)throw Error(`FRED API error: ${s.status} ${s.statusText}`);let r=await s.json();if(!r.observations||0===r.observations.length)throw Error(`No observations found for series ${e}`);let n=r.observations[0];return{value:parseFloat(n.value),date:n.date}}async getMarketFundamentals(e){let t=`fundamentals_${e}`,a=this.cache.get(t);if(a&&a.provenance)return{data:a.data,provenance:{source:a.provenance.source,as_of:a.provenance.as_of,from_cache:!0,record_count:a.provenance.record_count},freshness:a.freshness};try{let a=await this.supabaseCircuitBreaker.execute(async()=>{let{data:t,error:a}=await this.supabase.from("market_fundamentals").select("*").eq("market_slug",e).order("as_of_date",{ascending:!1}).limit(1).single();if(a)throw Error(`Supabase error: ${a.message}`);return t});if(!a)return{data:null,provenance:{source:"Supabase:market_fundamentals",as_of:new Date().toISOString(),from_cache:!1,record_count:0},freshness:{is_fresh:!1,days_old:999,threshold_days:parseInt(process.env.FRESHNESS_FUNDAMENTALS_DAYS||"90"),status:"EXPIRED"}};let s=this.calculateFreshness(a.as_of_date,parseInt(process.env.FRESHNESS_FUNDAMENTALS_DAYS||"90")),r={source:"Supabase:market_fundamentals",as_of:a.as_of_date,from_cache:!1,record_count:1};return this.cache.set(t,{data:a,provenance:r,freshness:s},this.FUNDAMENTALS_CACHE_TTL),{data:a,provenance:r,freshness:s}}catch(e){throw console.error("Market fundamentals fetch error:",e),e}}async getComps(e,t=10){let a=`comps_${e}_${t}`,s=this.cache.get(a);if(s&&s.provenance)return{data:s.data,provenance:{source:s.provenance.source,as_of:s.provenance.as_of,from_cache:!0,record_count:s.provenance.record_count},freshness:s.freshness};try{let s=await this.supabaseCircuitBreaker.execute(async()=>{let{data:a,error:s}=await this.supabase.from("v_comps_trimmed").select("*").eq("market_slug",e).order("sale_date",{ascending:!1}).limit(t);if(s)throw Error(`Supabase comps error: ${s.message}`);return a||[]}),r=s.length>0?s[0].sale_date:null,n=r?this.calculateFreshness(r,parseInt(process.env.FRESHNESS_COMPS_DAYS||"180")):{is_fresh:!1,days_old:999,threshold_days:180,status:"EXPIRED"},o={source:"Supabase:v_comps_trimmed",as_of:r||new Date().toISOString(),from_cache:!1,record_count:s.length};return this.cache.set(a,{data:s,provenance:o,freshness:n},this.COMPS_CACHE_TTL),{data:s,provenance:o,freshness:n}}catch(e){return console.error("Comparables fetch error:",e),{data:[],provenance:{source:"Supabase:v_comps_trimmed",as_of:new Date().toISOString(),from_cache:!1,record_count:0},freshness:{is_fresh:!1,days_old:999,threshold_days:parseInt(process.env.FRESHNESS_COMPS_DAYS||"180"),status:"EXPIRED"}}}}calculateFreshness(e,t){let a;let s=new Date,r=new Date(e),n=Math.floor((s.getTime()-r.getTime())/864e5);return{is_fresh:"FRESH"==(a=n<=t?"FRESH":n<=1.5*t?"STALE":"EXPIRED"),days_old:n,threshold_days:t,status:a}}invalidateCache(e){e?console.log(`Invalidating cache pattern: ${e}`):(this.cache.clear(),console.log("Cache cleared"))}async healthCheck(){let e={};try{let t=Date.now();await this.fetchFredSeries("DFF"),e.fred={status:"healthy",latency_ms:Date.now()-t}}catch(t){e.fred={status:"unhealthy",error:String(t)}}try{let t=Date.now(),{data:a,error:s}=await this.supabase.from("market_fundamentals").select("count").limit(1);if(s)throw s;e.supabase={status:"healthy",latency_ms:Date.now()-t}}catch(t){e.supabase={status:"unhealthy",error:String(t)}}let t=Object.values(e).filter(e=>"unhealthy"===e.status).length;return{status:0===t?"healthy":t<Object.keys(e).length?"degraded":"unhealthy",checks:e}}}let c=null;function i(){return c||(c=new o),c}},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=82);module.exports=a})();
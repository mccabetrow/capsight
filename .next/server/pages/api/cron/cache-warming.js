"use strict";(()=>{var e={};e.id=11,e.ids=[11],e.modules={2885:e=>{e.exports=require("@supabase/supabase-js")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},2824:e=>{e.exports=require("next/server")},4770:e=>{e.exports=require("crypto")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},8607:(e,t,a)=>{a.r(t),a.d(t,{config:()=>y,default:()=>E,routeModule:()=>D});var r={};a.r(r),a.d(r,{GET:()=>S,POST:()=>w});var s=a(1802),o=a(7153),n=a(6249),c=a(2824),i=a(9122),_=a(2885);a(4770);let l=(0,_.createClient)("https://azwkiifefkwewruyplcj.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY);function u(){return`${Date.now()}-${Math.random().toString(36).substring(2)}`}async function h(e){try{let t={id:e.id||u(),event_type:e.event_type,market_slug:e.market_slug,source:e.source||"API",processed_records:e.processed_records||0,cache_invalidated:e.cache_invalidated||[],processing_time_ms:e.processing_time_ms||0,checksum:e.checksum,metadata:e.metadata,created_at:new Date().toISOString()},{error:a}=await l.from("ingestion_events").insert(t);a&&console.error("Failed to log ingestion event:",a)}catch(e){console.error("Ingestion event logging error:",e)}}async function d(e){try{let t=e.id||u(),a={id:t,job_type:e.job_type,status:"QUEUED",market_slug:e.market_slug,input_data:e.input_data,output_data:e.output_data,error_message:e.error_message,processing_time_ms:e.processing_time_ms,started_at:e.started_at,completed_at:e.completed_at,created_at:new Date().toISOString()},{error:r}=await l.from("jobs").insert(a);return r&&console.error("Failed to create job record:",r),t}catch(e){return console.error("Job creation error:",e),u()}}async function m(e,t){try{let{error:a}=await l.from("jobs").update(t).eq("id",e);a&&console.error("Failed to update job status:",a)}catch(e){console.error("Job status update error:",e)}}async function p(e){try{let t={...e,created_at:new Date().toISOString()},{error:a}=await l.from("cache_metrics").insert(t);a&&console.error("Failed to log cache metric:",a)}catch(e){console.error("Cache metric logging error:",e)}}let f=process.env.CRON_SECRET||"development-cron-secret",g=["dfw","atl","phx","ie","sav"];async function w(e){let t;let a=Date.now();try{if(e.headers.get("authorization")!==`Bearer ${f}`)return c.NextResponse.json({error:"Unauthorized"},{status:401});console.log("\uD83D\uDD04 Starting cache warming and maintenance job..."),t=await d({job_type:"cache_warming",started_at:new Date().toISOString()}),await m(t,{status:"RUNNING"});let r=(0,i.M)(),s={macro_data:{success:!1,latency_ms:void 0,error:void 0},markets_warmed:0,comps_cached:0,total_cache_operations:0};console.log("\uD83D\uDCCA Warming macro data cache...");try{let e=Date.now(),{data:t}=await r.getMacroData();s.macro_data={success:!0,latency_ms:Date.now()-e,error:void 0},s.total_cache_operations++,console.log(`✅ Macro data cached: Fed Funds ${t.fed_funds_rate}%, 10Y Treasury ${t.treasury_10yr}%`)}catch(e){s.macro_data={success:!1,latency_ms:void 0,error:e instanceof Error?e.message:"Unknown error"},console.error("❌ Failed to warm macro data cache:",e)}for(let e of(console.log("\uD83C\uDFE2 Warming market fundamentals cache..."),g))try{let{data:t,freshness:a}=await r.getMarketFundamentals(e);t&&(s.markets_warmed++,s.total_cache_operations++,console.log(`✅ ${e}: ${t.city} (${a.status}, ${a.days_old}d old)`))}catch(t){console.error(`❌ Failed to warm ${e} fundamentals:`,t)}for(let e of(console.log("\uD83C\uDFD7️ Warming comparables cache..."),g))try{let{data:t}=await r.getComps(e,15);s.comps_cached+=t.length,s.total_cache_operations++,console.log(`✅ ${e}: ${t.length} comparables cached`)}catch(t){console.error(`❌ Failed to warm ${e} comps:`,t)}console.log("\uD83E\uDE7A Performing system health check...");let o=await r.healthCheck(),n={overall_status:o.status,data_sources_healthy:Object.values(o.checks).filter(e=>"healthy"===e.status).length,stale_markets_count:0,oldest_data_days:0},_=0,l=0;for(let e of g)try{let{freshness:t}=await r.getMarketFundamentals(e);t.days_old>_&&(_=t.days_old),!t.is_fresh&&l++}catch(e){l++}n.stale_markets_count=l,n.oldest_data_days=_,console.log("\uD83E\uDDF9 Performing maintenance tasks...");let u={cache_cleanup:!1,circuit_breaker_reset:!1};u.cache_cleanup=!0,u.circuit_breaker_reset=!0;let w=new Date(Date.now()+216e5),S=Date.now()-a;console.log(`✅ Cache warming completed in ${S}ms`);let E={success:!0,timestamp:new Date().toISOString(),execution_time_ms:S,cache_warming:s,health_summary:n,maintenance:u,next_run:w.toISOString()};return t&&await m(t,{status:"COMPLETED",output_data:{cache_operations:s.total_cache_operations,markets_warmed:s.markets_warmed,health_status:n.overall_status},processing_time_ms:S,completed_at:new Date().toISOString()}),await h({event_type:"cache.warming",source:"cron-job",processed_records:s.total_cache_operations,cache_invalidated:[],processing_time_ms:S,metadata:{markets_warmed:s.markets_warmed,comps_cached:s.comps_cached,health_status:n.overall_status}}),await p({metric_name:"cache_warming_operations",metric_value:s.total_cache_operations,tags:{job_type:"cache_warming",status:"success"},created_at:new Date().toISOString()}),c.NextResponse.json(E,{status:200,headers:{"Cache-Control":"no-cache","X-Cron-Job":"cache-warming","X-Next-Run":E.next_run}})}catch(e){return console.error("❌ Cron job failed:",e),t&&await m(t,{status:"FAILED",error_message:e instanceof Error?e.message:String(e),processing_time_ms:Date.now()-a,completed_at:new Date().toISOString()}),c.NextResponse.json({success:!1,timestamp:new Date().toISOString(),execution_time_ms:Date.now()-a,error:e instanceof Error?e.message:"Unknown error"},{status:500,headers:{"X-Cron-Job":"cache-warming","X-Error":"true"}})}}async function S(e){return c.NextResponse.json({service:"cache-warming-cron",status:"ready",description:"POST to this endpoint with Bearer token to run cache warming",next_scheduled_run:new Date(Date.now()+216e5).toISOString(),markets_monitored:g,cache_types:["macro_data","market_fundamentals","comparables"],authentication:"Bearer token required"},{status:200,headers:{"Cache-Control":"no-cache"}})}let E=(0,n.l)(r,"default"),y=(0,n.l)(r,"config"),D=new s.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/cron/cache-warming",pathname:"/api/cron/cache-warming",bundlePath:"",filename:""},userland:r})},9122:(e,t,a)=>{a.d(t,{M:()=>i});var r=a(2885);class s{set(e,t,a){let r=Date.now();this.cache.set(e,{data:t,timestamp:r,expires_at:r+a})}get(e){let t=this.cache.get(e);return!t||t.expires_at<Date.now()?(this.cache.delete(e),null):t.data}delete(e){this.cache.delete(e)}clear(){this.cache.clear()}constructor(){this.cache=new Map}}class o{constructor(e=3,t=12e4){this.failure_threshold=e,this.timeout_ms=t,this.state={state:"closed",failure_count:0}}async execute(e){if("open"===this.state.state){if(Date.now()>=(this.state.next_attempt_time||0))this.state.state="half-open";else throw Error(`Circuit breaker OPEN. Next attempt in ${Math.ceil(((this.state.next_attempt_time||0)-Date.now())/1e3)}s`)}try{let t=await e();return("half-open"===this.state.state||this.state.failure_count>0)&&(this.state={state:"closed",failure_count:0}),t}catch(e){throw this.state.failure_count++,this.state.last_failure_time=Date.now(),this.state.failure_count>=this.failure_threshold&&(this.state.state="open",this.state.next_attempt_time=Date.now()+this.timeout_ms),e}}getState(){return{...this.state}}}class n{constructor(){this.cache=new s,this.fredCircuitBreaker=new o(3,12e4),this.supabaseCircuitBreaker=new o(5,6e4),this.FRED_BASE_URL="https://api.stlouisfed.org/fred",this.MACRO_CACHE_TTL=6e4*parseInt(process.env.CACHE_TTL_MACRO_MINUTES||"30"),this.FUNDAMENTALS_CACHE_TTL=36e5*parseInt(process.env.CACHE_TTL_FUNDAMENTALS_HOURS||"24"),this.COMPS_CACHE_TTL=36e5*parseInt(process.env.CACHE_TTL_COMPS_HOURS||"24"),this.supabase=(0,r.createClient)("https://azwkiifefkwewruyplcj.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY)}async getMacroData(){let e="macro_data",t=this.cache.get(e);if(t&&t.provenance)return{data:t.data,provenance:{source:t.provenance.source,as_of:t.provenance.as_of,from_cache:!0,breaker_status:t.provenance.breaker_status}};try{let t=await this.fredCircuitBreaker.execute(async()=>{let e=await this.fetchFredSeries("DFF"),t=await this.fetchFredSeries("GS10");return{fed_funds_rate:e.value,treasury_10yr:t.value,as_of:e.date,source:"FRED"}}),a={source:"FRED",as_of:t.as_of,from_cache:!1,breaker_status:this.fredCircuitBreaker.getState().state};return this.cache.set(e,{data:t,provenance:a},this.MACRO_CACHE_TTL),{data:t,provenance:a}}catch(a){console.error("FRED API error:",a);let t=this.cache.get(e);if(t&&t.provenance)return{data:t.data,provenance:{source:t.provenance.source,as_of:t.provenance.as_of,from_cache:!0,breaker_status:this.fredCircuitBreaker.getState().state}};throw Error(`FRED API unavailable and no cached data: ${a}`)}}async fetchFredSeries(e){let t=process.env.FRED_API_KEY;if(!t)throw Error("FRED_API_KEY not configured");let a=`${this.FRED_BASE_URL}/series/observations?series_id=${e}&api_key=${t}&file_type=json&limit=1&sort_order=desc`,r=await fetch(a,{method:"GET",headers:{"User-Agent":"CapSight/1.0"},signal:AbortSignal.timeout(1e4)});if(!r.ok)throw Error(`FRED API error: ${r.status} ${r.statusText}`);let s=await r.json();if(!s.observations||0===s.observations.length)throw Error(`No observations found for series ${e}`);let o=s.observations[0];return{value:parseFloat(o.value),date:o.date}}async getMarketFundamentals(e){let t=`fundamentals_${e}`,a=this.cache.get(t);if(a&&a.provenance)return{data:a.data,provenance:{source:a.provenance.source,as_of:a.provenance.as_of,from_cache:!0,record_count:a.provenance.record_count},freshness:a.freshness};try{let a=await this.supabaseCircuitBreaker.execute(async()=>{let{data:t,error:a}=await this.supabase.from("market_fundamentals").select("*").eq("market_slug",e).order("as_of_date",{ascending:!1}).limit(1).single();if(a)throw Error(`Supabase error: ${a.message}`);return t});if(!a)return{data:null,provenance:{source:"Supabase:market_fundamentals",as_of:new Date().toISOString(),from_cache:!1,record_count:0},freshness:{is_fresh:!1,days_old:999,threshold_days:parseInt(process.env.FRESHNESS_FUNDAMENTALS_DAYS||"90"),status:"EXPIRED"}};let r=this.calculateFreshness(a.as_of_date,parseInt(process.env.FRESHNESS_FUNDAMENTALS_DAYS||"90")),s={source:"Supabase:market_fundamentals",as_of:a.as_of_date,from_cache:!1,record_count:1};return this.cache.set(t,{data:a,provenance:s,freshness:r},this.FUNDAMENTALS_CACHE_TTL),{data:a,provenance:s,freshness:r}}catch(e){throw console.error("Market fundamentals fetch error:",e),e}}async getComps(e,t=10){let a=`comps_${e}_${t}`,r=this.cache.get(a);if(r&&r.provenance)return{data:r.data,provenance:{source:r.provenance.source,as_of:r.provenance.as_of,from_cache:!0,record_count:r.provenance.record_count},freshness:r.freshness};try{let r=await this.supabaseCircuitBreaker.execute(async()=>{let{data:a,error:r}=await this.supabase.from("v_comps_trimmed").select("*").eq("market_slug",e).order("sale_date",{ascending:!1}).limit(t);if(r)throw Error(`Supabase comps error: ${r.message}`);return a||[]}),s=r.length>0?r[0].sale_date:null,o=s?this.calculateFreshness(s,parseInt(process.env.FRESHNESS_COMPS_DAYS||"180")):{is_fresh:!1,days_old:999,threshold_days:180,status:"EXPIRED"},n={source:"Supabase:v_comps_trimmed",as_of:s||new Date().toISOString(),from_cache:!1,record_count:r.length};return this.cache.set(a,{data:r,provenance:n,freshness:o},this.COMPS_CACHE_TTL),{data:r,provenance:n,freshness:o}}catch(e){return console.error("Comparables fetch error:",e),{data:[],provenance:{source:"Supabase:v_comps_trimmed",as_of:new Date().toISOString(),from_cache:!1,record_count:0},freshness:{is_fresh:!1,days_old:999,threshold_days:parseInt(process.env.FRESHNESS_COMPS_DAYS||"180"),status:"EXPIRED"}}}}calculateFreshness(e,t){let a;let r=new Date,s=new Date(e),o=Math.floor((r.getTime()-s.getTime())/864e5);return{is_fresh:"FRESH"==(a=o<=t?"FRESH":o<=1.5*t?"STALE":"EXPIRED"),days_old:o,threshold_days:t,status:a}}invalidateCache(e){e?console.log(`Invalidating cache pattern: ${e}`):(this.cache.clear(),console.log("Cache cleared"))}async healthCheck(){let e={};try{let t=Date.now();await this.fetchFredSeries("DFF"),e.fred={status:"healthy",latency_ms:Date.now()-t}}catch(t){e.fred={status:"unhealthy",error:String(t)}}try{let t=Date.now(),{data:a,error:r}=await this.supabase.from("market_fundamentals").select("count").limit(1);if(r)throw r;e.supabase={status:"healthy",latency_ms:Date.now()-t}}catch(t){e.supabase={status:"unhealthy",error:String(t)}}let t=Object.values(e).filter(e=>"unhealthy"===e.status).length;return{status:0===t?"healthy":t<Object.keys(e).length?"degraded":"unhealthy",checks:e}}}let c=null;function i(){return c||(c=new n),c}},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=t(t.s=8607);module.exports=a})();